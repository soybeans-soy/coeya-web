<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voix en Soie - ãƒ¬ãƒƒã‚¹ãƒ³äºˆç´„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Montserrat:wght=500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 
    
<style>
    /* LPã®ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒã‚’çµ±åˆ */
    :root {
        --primary-color: #e2b435; /* Gold - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/æœ‰åŠ¹æ™‚ã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ */
        --secondary-color: #eff079; /* Pale Yellow - å¼·èª¿/æ³¨æ„å–šèµ·ã®èƒŒæ™¯è‰² */
        --disabled-color: #b5b5b5; /* Middle Gray - ç„¡åŠ¹æ™‚ã®è‰² */
        --available-color: #0b5d85; /* Mint Green - ç©ºãæ ã®è‰² */
        --text-color: #000000;
        --light-bg: #f8f9fa;
        --button-radius: 0.375rem; /* Bootstrapãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è§’ä¸¸ã‚µã‚¤ã‚ºã«è¨­å®š */
    }

    body { 
        font-family: 'Noto Sans JP', sans-serif; 
        background-color: var(--light-bg); 
        padding-top: 20px; 
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (ä½¿ç”¨ç®‡æ‰€ã‚’æ¸›ã‚‰ã™ãŸã‚ä¸€æ—¦å‰Šé™¤) */
    
    /* ã‚¹ãƒ†ãƒƒãƒ—å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .step-section { display: none; }
    .active-step { display: block; }

    /* ã‚«ãƒ¼ãƒ‰é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
    .course-card, .instructor-card { 
        cursor: pointer; 
        transition: transform 0.2s, box-shadow 0.2s; 
        border-left: 5px solid transparent;
        min-height: 150px;
        /* å½¢çŠ¶ã¯Bootstrapã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹ */
    }
    .course-card.selected, .instructor-card.selected { 
        border-left-color: var(--primary-color); 
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
        background-color: #f0f8ff; 
    }

    /* æ—¥æ™‚é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
    .calendar-header { background-color: var(--primary-color); color: white; padding: 10px; border-radius: 0.375rem 0.375rem 0 0; font-weight: bold; }
    .slot-button { width: 100%; margin-bottom: 8px; font-weight: bold; }
    
    /* -------------------------------------- */
    /* â˜… è‰²ã®çµ±ä¸€ (ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®ä¸Šæ›¸ã) â˜… */
    /* -------------------------------------- */
    
    /* å…¨ã¦ã®æ¬¡ã¸/ç¢ºå®šãƒœã‚¿ãƒ³(btn-secondary/btn-primary)ã‚’ã‚´ãƒ¼ãƒ«ãƒ‰ã«ã™ã‚‹ */
    .btn-secondary, .btn-primary {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: white !important;
        font-weight: bold;
    }
    .btn-secondary:hover, .btn-primary:hover {
        background-color: #c99c2d !important; /* ãƒ›ãƒãƒ¼ã§å°‘ã—æ¿ƒã„ã‚´ãƒ¼ãƒ«ãƒ‰ */
        border-color: #c99c2d !important;
    }
    
    /* æ¬¡ã¸/ç¢ºå®šãƒœã‚¿ãƒ³ï¼ˆDISABLEDæ™‚ï¼‰ï¼šMiddle Grayã‚’é©ç”¨ */
    .btn-secondary:disabled,
    .btn-primary:disabled { 
        background-color: var(--disabled-color) !important; 
        border-color: var(--disabled-color) !important; 
        color: #777777 !important; 
        opacity: 1 !important; 
        cursor: not-allowed; 
        box-shadow: none; 
    }
    
    /* -------------------------------------- */
    /* â˜… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç©ºãæ ã¨é¸æŠä¸­ã‚’çµ±ä¸€ â˜… */
    /* -------------------------------------- */

    /* äºˆç´„å¯èƒ½æ—¥ (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼) ã®è‰²ã‚’Mint Greenã«çµ±ä¸€ */
    .calendar-day.bg-success { 
        background-color: var(--available-color) !important; 
        border-color: var(--available-color) !important; 
    }
    /* é¸æŠä¸­ã®æ—¥ä»˜ã®è‰²ã‚’Primary Color(Gold)ã«çµ±ä¸€ */
    .calendar-day.bg-info { 
        background-color: var(--primary-color) !important; 
        border-color: var(--primary-color) !important; 
    } 
    /* é¸æŠä¸­ã®æ™‚é–“å¸¯ãƒœã‚¿ãƒ³ã®è‰²ã‚’Primary Color(Gold)ã«çµ±ä¸€ */
    .slot-button.btn-primary {
        background-color: var(--primary-color) !important; 
        border-color: var(--primary-color) !important; 
        color: white !important;
    }


    /* STEP 4 ç‰¹æ®Šãƒ‡ã‚¶ã‚¤ãƒ³ */
    .text-primary-custom { color: var(--primary-color) !important; }
    #summary-display-container {
        border-left-color: var(--primary-color) !important;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #policy-agree-container {
        background-color: var(--secondary-color) !important;
        border-color: #dc3545 !important; 
    }
    
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ (ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³) ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯Bootstrapãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹ */
</style>

</head>
<body>

<div class="container">
    <h2 class="text-center mb-4 text-primary-custom"><i class="fas fa-calendar-alt me-2"></i>Voix en Soie - ãƒ¬ãƒƒã‚¹ãƒ³äºˆç´„</h2>
    <div class="alert alert-info" id="message-area" style="display:none;"></div>
    
    <div class="progress mb-4" role="progressbar" aria-label="äºˆç´„ã‚¹ãƒ†ãƒƒãƒ—" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar bg-primary-custom" id="progress-bar" style="width: 25%"></div>
    </div>

    <div id="step-course" class="step-section active-step">
        <h3 class="mb-3"><i class="fas fa-graduation-cap me-2"></i>STEP 1: ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div class="row g-4" id="course-selection-container"></div>
        <button class="btn btn-secondary mt-4" onclick="nextStep(2)" id="course-next-btn" disabled><i class="fas fa-arrow-right me-2"></i>æ¬¡ã¸</button>
    </div>

    <div id="step-instructor" class="step-section">
        <h3 class="mb-3"><i class="fas fa-chalkboard-teacher me-2"></i>STEP 2: è¬›å¸«ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div class="row g-4" id="instructor-selection-container"></div>
        <div class="mt-4">
            <button class="btn btn-outline-secondary me-2" onclick="prevStep(1)"><i class="fas fa-arrow-left me-2"></i>æˆ»ã‚‹</button>
            <button class="btn btn-secondary" onclick="nextStep(3)" id="instructor-next-btn" disabled><i class="fas fa-arrow-right me-2"></i>æ¬¡ã¸</button>
        </div>
    </div>

    <div id="step-datetime" class="step-section position-relative">
        <h3 class="mb-3"><i class="fas fa-clock me-2"></i>STEP 3: æ—¥ä»˜ã¨æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div id="loading-datetime" class="loading-overlay" style="display: none;"><i class="fas fa-spinner fa-spin fa-3x"></i></div>
        <div class="card p-4">
            <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-light btn-sm" id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                <span id="current-month-year"></span>
                <button class="btn btn-light btn-sm" id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered text-center calendar-table" id="calendar-body">
                    <thead>
                        <tr><th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="time-slots-container" class="mt-4" style="min-height: 100px;">
                <p class="text-muted text-center" id="slot-placeholder">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-outline-secondary me-2" onclick="prevStep(2)"><i class="fas fa-arrow-left me-2"></i>æˆ»ã‚‹</button>
                <button class="btn btn-secondary" onclick="nextStep(4)" id="datetime-next-btn" disabled><i class="fas fa-arrow-right me-2"></i>æ¬¡ã¸</button>
            </div>
        </div>
    </div>

    <div id="step-info" class="step-section position-relative">
        <h3 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>STEP 4: äºˆç´„æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
        <div id="loading-info" class="loading-overlay" style="display: none;"><i class="fas fa-spinner fa-spin fa-3x"></i></div>
        <div class="card p-4">
            
            <div class="card bg-light p-3 mb-4 border-start border-5 border-primary-custom" id="summary-display-container">
                <h5 class="fw-bold text-primary-custom mb-2"><i class="fas fa-clipboard-check me-2"></i>ã”äºˆç´„å†…å®¹ã®æœ€çµ‚ç¢ºèª</h5>
                <div id="summary-display">
                    </div>
            </div>

            <form id="booking-form">
                <div class="mb-3">
                    <label for="student-name" class="form-label">ãŠåå‰ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="student-name" required>
                </div>
                <div class="mb-3">
                    <label for="student-email" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="student-email" required>
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">å‚™è€ƒ/ç‰¹è¨˜äº‹é …</label>
                    <textarea class="form-control" id="notes" rows="3"></textarea>
                </div>

                <div class="form-check p-3 mb-4 bg-secondary-custom border border-3 border-danger rounded shadow-sm align-items-center d-flex" id="policy-agree-container">
                    <input class="form-check-input flex-shrink-0 me-3" type="checkbox" id="policy-agree" required>
                    <label class="form-check-label fw-bold small" for="policy-agree" style="line-height: 1.5;">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™ã€‚ <span class="text-danger">*</span>
                        <p class="small text-muted mt-1 mb-0 fw-normal">â€»ã”äºˆç´„ç¢ºå®šå‰ã«å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚ãƒã‚§ãƒƒã‚¯ãŒãªã„å ´åˆã€äºˆç´„ã‚’ç¢ºå®šã§ãã¾ã›ã‚“ã€‚</p>
                    </label>
                </div>
                
                <div class="mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="prevStep(3)"><i class="fas fa-arrow-left me-2"></i>æˆ»ã‚‹</button>
                    <button type="submit" class="btn btn-primary bg-primary-custom border-primary-custom" id="submit-booking-btn"><i class="fas fa-paper-plane me-2"></i>ã“ã®å†…å®¹ã§äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="step-complete" class="step-section">
        <div class="alert alert-success text-center p-5">
            <i class="fas fa-check-circle fa-4x mb-3"></i>
            <h3>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
            <p class="lead">ã”ç™»éŒ²ã„ãŸã ã„ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€äºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚ã”ç¢ºèªãã ã•ã„ã€‚</p>
            <p class="small">äºˆç´„å†…å®¹ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã¯ã€å±Šã„ãŸãƒ¡ãƒ¼ãƒ«ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹›å¾…ã‹ã‚‰è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            <!--
            <a href="#" class="btn btn-primary bg-primary-custom border-primary-custom mt-3" onclick="window.location.reload(); return false;">æœ€åˆã«æˆ»ã‚‹</a>
            -->
        </div>
    </div>
</div>

<script>
    // **********************************************
    // 1. ã€è¨­å®šã€‘ã‚³ãƒ¼ã‚¹ãƒ»è¬›å¸«æƒ…å ± (Code.gså´ã®è¨­å®šã¨åŒæœŸ)
    // **********************************************
    const LESSON_DURATIONS = [
        { id: 't-60-exp', name: 'ä½“é¨“ãƒ¬ãƒƒã‚¹ãƒ³', duration: 60, price: 5000 },
        { id: 't-60-std', name: 'é€šå¸¸ãƒ¬ãƒƒã‚¹ãƒ³', duration: 60, price: 8000 },
        { id: 't-90-pro', name: 'ãƒ—ãƒ­é¤Šæˆã‚³ãƒ¼ã‚¹', duration: 90, price: 12000 },
        { id: 't-30-opt', name: 'ç‰¹åˆ¥çŸ­ç¸®ã‚³ãƒ¼ã‚¹', duration: 30, price: 4000 }
    ];
    
    const INSTRUCTORS = [
        { id: 'instructor01', name: 'å¾Œè—¤ èœç¾ å…ˆç”Ÿ' },
    ];

    // **********************************************
    // 2. çŠ¶æ…‹ç®¡ç†å¤‰æ•°
    // **********************************************
    let currentStep = 1;
    let selectedCourse = null;
    let selectedInstructor = null;
    let selectedDate = null;
    let selectedTime = null;
    let availableSlots = {}; 
    let currentDisplayDate = new Date(); 
    const TODAY = new Date();
    TODAY.setHours(0, 0, 0, 0);
    // Code.gsã§å®šç¾©ã—ãŸæœ€å°åˆ†å‰²å˜ä½ã¨åŒæœŸã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
    const MIN_SLOT_DURATION = 60; 

    // **********************************************
    // 3. UIæ“ä½œãƒ­ã‚¸ãƒƒã‚¯
    // **********************************************
    const STEP_IDS = { 1: 'step-course', 2: 'step-instructor', 3: 'step-datetime', 4: 'step-info', 5: 'step-complete' };
    const MONTH_NAMES = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
    const DAY_NAMES = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];

    document.addEventListener('DOMContentLoaded', () => {
        renderCourseCards();
        renderInstructorCards();
        document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
        document.getElementById('booking-form').addEventListener('submit', handleFormSubmit);
        fetchAvailableSlots();
        updateProgressBar();
    });

    function updateProgressBar() {
        const percent = (currentStep - 1) * 25;
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-bar').setAttribute('aria-valuenow', percent);
    }

function updateUI() {
        Object.keys(STEP_IDS).forEach(stepNum => {
            const stepElement = document.getElementById(STEP_IDS[stepNum]);
            if (parseInt(stepNum) === currentStep) {
                stepElement.classList.add('active-step');
            } else {
                stepElement.classList.remove('active-step');
            }
        });
        updateProgressBar();

        // â˜…ã€ä¿®æ­£ç®‡æ‰€ã€‘STEP 2 ã¾ãŸã¯ 3 ã«ç§»å‹•ã—ãŸéš›ã«ã€è¬›å¸«ãƒªã‚¹ãƒˆã¨æ—¥ç¨‹ã‚’å†æç”»ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ  â˜…
        if (currentStep === 2) {
            // STEP 2: è¬›å¸«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            renderInstructorCards(); 
            // è¬›å¸«ãŒ1äººã®å ´åˆã€è‡ªå‹•é¸æŠã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§fetchAvailableSlotsã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
        } else if (currentStep === 3) {
            // STEP 3: æ—¥ä»˜é¸æŠã¸æˆ»ã£ãŸå ´åˆã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ç©ºãæ ã‚’å†æç”»
            renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”» (fetchAvailableSlotsã®SuccessHandlerå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€å®Ÿè³ªã¯ä¸è¦ã ãŒæ•´åˆæ€§ã®ãŸã‚è¿½åŠ )
            renderAvailableSlots(selectedDate); // æ—¥ä»˜é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒã—ã€ç©ºãæ ä¸€è¦§ã‚’æ›´æ–°
        }
        // â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…
    }

    function nextStep(step) {
        if (!validateStep(currentStep)) return;
        currentStep = step;
        updateUI();
        if (step === 4) { updateSummaryDisplay(); }
    }

    function prevStep(step) {
        currentStep = step;
        updateUI();
    }

    function validateStep(step) {
        hideMessage();
        if (step === 1 && !selectedCourse) { showMessage('error', 'ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return false; }
        if (step === 2 && !selectedInstructor) { showMessage('error', 'è¬›å¸«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return false; }
        if (step === 3 && (!selectedDate || !selectedTime)) { showMessage('error', 'æ—¥ä»˜ã¨æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return false; }
        if (step === 4) {
            const name = document.getElementById('student-name').value;
            const email = document.getElementById('student-email').value;
            if (!name || !email) { showMessage('error', 'ãŠåå‰ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™ã€‚'); return false; }
            if (!document.getElementById('policy-agree').checked) { showMessage('error', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚'); return false; }
        }
        return true;
    }

    // --- ã‚³ãƒ¼ã‚¹/è¬›å¸«ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º ---
    function renderCourseCards() {
        const container = document.getElementById('course-selection-container');
        container.innerHTML = LESSON_DURATIONS.map(course => `
            <div class="col-md-4">
                <div class="card p-3 course-card" data-id="${course.id}" onclick="selectCourse('${course.id}')">
                    <div class="card-body">
                        <h5 class="card-title text-primary-custom">${course.name}</h5>
                        <p class="card-text small mb-1">æ™‚é–“: ${course.duration}åˆ†</p>
                        <p class="card-text small">æ–™é‡‘: ${course.price.toLocaleString()}å††</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function selectCourse(id) {
        selectedCourse = LESSON_DURATIONS.find(c => c.id === id);
        document.querySelectorAll('.course-card').forEach(card => {
            card.classList.toggle('selected', card.dataset.id === id);
        });
        document.getElementById('course-next-btn').disabled = false;
        selectedDate = null;
        selectedTime = null;
        renderAvailableSlots(null);
        renderCalendar(); 
    }
    
    function renderInstructorCards() {
        const container = document.getElementById('instructor-selection-container');
        container.innerHTML = INSTRUCTORS.map(inst => `
            <div class="col-md-4">
                <div class="card p-3 instructor-card" data-id="${inst.id}" onclick="selectInstructor('${inst.id}')">
                    <div class="card-body">
                        <h5 class="card-title">${inst.name}</h5>
                        <p class="card-text small text-muted">æ‹…å½“è¬›å¸«</p>
                    </div>
                </div>
            </div>
        `).join('');
        if (INSTRUCTORS.length === 1) {
            selectInstructor(INSTRUCTORS[0].id);
        }
    }

    function selectInstructor(id) {
        selectedInstructor = INSTRUCTORS.find(c => c.id === id);
        document.querySelectorAll('.instructor-card').forEach(card => {
            card.classList.toggle('selected', card.dataset.id === id);
        });
        document.getElementById('instructor-next-btn').disabled = false;
        selectedDate = null;
        selectedTime = null;
        renderAvailableSlots(null);
        fetchAvailableSlots(); 
    }


    // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ---
    function changeMonth(delta) {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + delta);
        // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰ã€é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        selectedDate = null;
        selectedTime = null;
        
        // ä¿®æ­£ç®‡æ‰€: renderCalendar()ã®ä»£ã‚ã‚Šã«ã€ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã€
        // æç”»ã¯ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†å¾Œ(handleSuccessFetchå†…)ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        fetchAvailableSlots(); 
        
        renderAvailableSlots(null);
        hideMessage();
    }

    function renderCalendar() {
        const calendarBody = document.querySelector('#calendar-body tbody');
        calendarBody.innerHTML = ''; 
        
        const year = currentDisplayDate.getFullYear();
        const month = currentDisplayDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        
        document.getElementById('current-month-year').textContent = `${year}å¹´ ${MONTH_NAMES[month]}`;
        
        let date = 1;
        for (let i = 0; i < 6; i++) { 
            const row = calendarBody.insertRow();
            let hasDate = false;

            for (let j = 0; j < 7; j++) { 
                const cell = row.insertCell();
                cell.classList.add('p-1', 'calendar-cell', 'text-center'); 
                cell.style.height = '40px'; 

                if (i === 0 && j < firstDayOfMonth.getDay()) {
                    cell.textContent = '';
                } else if (date > lastDayOfMonth.getDate()) {
                    cell.textContent = '';
                } else {
                    const currentDate = new Date(year, month, date);
                    currentDate.setHours(0, 0, 0, 0); 
                    
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    const slots = availableSlots[dateKey];

                    cell.innerHTML = `<div>${date}</div>`;
                    cell.classList.add('calendar-day');

                    if (currentDate < TODAY) {
                        cell.classList.add('text-muted');
                    }
                    else if (slots && slots.length > 0) {
                        cell.classList.add('bg-success', 'text-white'); 
                        cell.style.cursor = 'pointer'; 
                        cell.setAttribute('data-date', dateKey);
                        cell.onclick = () => selectDate(dateKey);
                    } else {
                        cell.classList.add('text-muted');
                    }
                    
                    if (selectedDate === dateKey) {
                        cell.classList.remove('bg-success', 'text-white');
                        cell.classList.add('bg-info', 'text-white');
                    }

                    date++;
                    hasDate = true;
                }
            }
            if (!hasDate) break; 
        }
    }

    function selectDate(dateKey) {
        selectedDate = dateKey;
        selectedTime = null; 
        document.querySelectorAll('.calendar-day').forEach(cell => {
            if (cell.classList.contains('bg-info')) {
                cell.classList.remove('bg-info', 'text-white');
                const cellDateKey = cell.getAttribute('data-date');
                if (cellDateKey && availableSlots[cellDateKey] && availableSlots[cellDateKey].length > 0) {
                     cell.classList.add('bg-success', 'text-white');
                } else {
                     cell.classList.add('text-muted');
                }
            }
            if (cell.getAttribute('data-date') === dateKey) {
                cell.classList.remove('bg-success', 'text-muted');
                cell.classList.add('bg-info', 'text-white');
            }
        });
        renderAvailableSlots(dateKey);
    }
    
    // é€£ç¶šç©ºãæ ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
    function renderAvailableSlots(dateKey) {
        const container = document.getElementById('time-slots-container');
        document.getElementById('datetime-next-btn').disabled = true;
        
        if (!selectedCourse) {
            container.innerHTML = '<p class="text-muted text-center" id="slot-placeholder">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
            return;
        }

        if (!dateKey || !availableSlots[dateKey] || availableSlots[dateKey].length === 0) {
            container.innerHTML = '<p class="text-muted text-center" id="slot-placeholder">é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã«ç©ºãæ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        const availableTimes = availableSlots[dateKey].sort(); 
        const requiredDuration = selectedCourse.duration; 
        const minSlotDuration = MIN_SLOT_DURATION; 

        const validSlots = [];

        availableTimes.forEach(time => {
            const timeParts = time.split(':').map(Number);
            let startTimeInMinutes = timeParts[0] * 60 + timeParts[1];
            
            const requiredEndTimeInMinutes = startTimeInMinutes + requiredDuration;
            
            let isSlotValid = true;
            let currentTimeInMinutes = startTimeInMinutes;
            
            while (currentTimeInMinutes < requiredEndTimeInMinutes) {
                
                const hour = Math.floor(currentTimeInMinutes / 60);
                const minute = currentTimeInMinutes % 60;
                const checkTimeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                // å¿…è¦ãª60åˆ†åŒºé–“ãŒ availableTimes ã«å­˜åœ¨ã—ãªã„å ´åˆã€ç„¡åŠ¹
                if (!availableTimes.includes(checkTimeStr)) {
                    isSlotValid = false;
                    break;
                }
                
                // æ¬¡ã®60åˆ†åŒºé–“ã«ç§»å‹•
                currentTimeInMinutes += minSlotDuration;
            }

            if (isSlotValid) {
                validSlots.push(time);
            }
        });


        if (validSlots.length === 0) {
            container.innerHTML = '<p class="text-muted text-center" id="slot-placeholder">é¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹ã§ã¯ç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®ã‚³ãƒ¼ã‚¹ã‹æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
            return;
        }

        container.innerHTML = `
            <p class="fw-bold">ç©ºãæ™‚é–“å¸¯ (${dateKey}):</p>
            <div class="row g-2" id="slot-buttons">
                ${validSlots.map(time => `
                    <div class="col-4 col-sm-3 col-md-2">
                        <button class="btn btn-outline-primary slot-button" data-time="${time}" onclick="selectTime('${time}')">
                            ${time}
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function selectTime(time) {
        selectedTime = time;
        document.querySelectorAll('.slot-button').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        document.querySelector(`.slot-button[data-time="${time}"]`).classList.remove('btn-outline-primary');
        document.querySelector(`.slot-button[data-time="${time}"]`).classList.add('btn-primary');
        document.getElementById('datetime-next-btn').disabled = false;
    }
    
    // --- STEP 4 é¸æŠå†…å®¹è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    function getDayOfWeek(dateStr) {
        const parts = dateStr.split('-').map(Number);
        const date = new Date(parts[0], parts[1] - 1, parts[2]);
        return DAY_NAMES[date.getDay()];
    }

    // ä¿®æ­£ç®‡æ‰€: é¸æŠå†…å®¹ã®ãƒªãƒƒãƒè¡¨ç¤º
    function updateSummaryDisplay() {
        const display = document.getElementById('summary-display');
        const courseName = selectedCourse ? selectedCourse.name : 'æœªé¸æŠ';
        const duration = selectedCourse ? selectedCourse.duration : '-';
        const instructorName = selectedInstructor ? selectedInstructor.name : 'æœªé¸æŠ';
        const dateTimeStr = (selectedDate && selectedTime) ? 
            `${selectedDate} (${getDayOfWeek(selectedDate)}) ${selectedTime}` : 'æœªé¸æŠ';
        const price = selectedCourse ? selectedCourse.price.toLocaleString() : '-';

        display.innerHTML = `
            <dl class="row mb-0 small">
                <dt class="col-sm-3 fw-bold text-muted">ã‚³ãƒ¼ã‚¹å:</dt>
                <dd class="col-sm-9 fw-bold text-dark">${courseName} (${duration}åˆ†)</dd>
                
                <dt class="col-sm-3 fw-bold text-muted">è¬›å¸«å:</dt>
                <dd class="col-sm-9 fw-bold text-dark">${instructorName}</dd>

                <dt class="col-sm-3 fw-bold text-muted">æ—¥æ™‚:</dt>
                <dd class="col-sm-9 fw-bold text-primary-custom">${dateTimeStr}</dd>

                <dt class="col-sm-3 fw-bold text-muted border-top pt-2">æ–™é‡‘ (ç›®å®‰):</dt>
                <dd class="col-sm-9 fw-bold text-danger border-top pt-2">${price}å††</dd>
            </dl>
        `;
    }


    // --- ãƒ•ã‚©ãƒ¼ãƒ ã¨äºˆç´„å‡¦ç† ---
/**
     * ã‚¹ãƒ†ãƒƒãƒ—4ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’å‡¦ç†ã™ã‚‹ã€‚
     */
    function handleFormSubmit(event) {
        event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡ã‚’é˜²æ­¢

        // STEP 2, 3 ã®æƒ…å ±ãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
        if (!selectedDate || !selectedTime || !selectedCourse || !selectedInstructor) {
            showMessage('error', 'äºˆç´„æ—¥æ™‚ã¾ãŸã¯ã‚³ãƒ¼ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã£ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // STEP 4: é€£çµ¡å…ˆæƒ…å ±ã‚’å–å¾—
        const nameElement = document.getElementById('student-name');
        const emailElement = document.getElementById('student-email');
        const notesElement = document.getElementById('notes');
        
        // â˜…ä¿®æ­£ç®‡æ‰€: emailå¤‰æ•°ã®å®šç¾©ãŒç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£
        const name = nameElement ? nameElement.value.trim() : '';
        const email = emailElement ? emailElement.value.trim() : '';
        const notes = notesElement ? notesElement.value.trim() : '';

        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèª
        if (name.length === 0 || email.length === 0) {
            showMessage('error', 'ãŠåå‰ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
            return;
        }

        // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
        const bookingData = {
            date: selectedDate,
            time: selectedTime,
            duration: selectedCourse.duration,
            name: name, // ğŸ’¡ ã“ã“ã§å®šç¾©ã—ãŸ email å¤‰æ•°ãŒä½¿ã‚ã‚Œã‚‹
            email: email, // ğŸ’¡ ã“ã“ã§å®šç¾©ã—ãŸ email å¤‰æ•°ãŒä½¿ã‚ã‚Œã‚‹
            instructorId: selectedInstructor.id,
            courseName: selectedCourse.name,
            notes: notes
        };

        // GASã¸é€ä¿¡
        submitBooking(bookingData);
    }

    function showMessage(type, message) {
        const area = document.getElementById('message-area');
        area.className = `alert alert-${type === 'error' ? 'danger' : 'info'}`;
        area.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
        area.style.display = 'block';
        setTimeout(() => hideMessage(), 7000);
    }

    function hideMessage() {
        document.getElementById('message-area').style.display = 'none';
    }

    function showLoading(show, stepId) {
        const loadingOverlay = document.getElementById(`loading-${stepId}`);
        if (loadingOverlay) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
            const stepContent = document.querySelector(`#step-${stepId} .card`);
            if (stepContent) {
                stepContent.style.pointerEvents = show ? 'none' : 'auto';
                stepContent.style.opacity = show ? '0.5' : '1';
            }
        }
    }


    // **********************************************
    // 4. APIé€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯ (google.script.run)
    // **********************************************

    function fetchAvailableSlots() {
        if (currentStep !== 3) {
        } else {
            showLoading(true, 'datetime');
        }
        
        availableSlots = {}; 
        
        google.script.run
            .withSuccessHandler(handleSuccessFetch)
            .withFailureHandler(handleFailureFetch)
            .getAvailableSlots({ 
                instructorId: selectedInstructor ? selectedInstructor.id : INSTRUCTORS[0].id
            });
    }

function handleSuccessFetch(result) {
        showLoading(false, 'datetime');
        
        if (result && result.status === 'success') {
             availableSlots = result.data || {};
        } else if (result) {
             showMessage('error', result.error || 'ç©ºãæ™‚é–“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
             availableSlots = {};
        } else {
             showMessage('error', 'APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚');
             availableSlots = {};
        }

        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå®Œäº†ã—ãŸæ™‚ç‚¹ã§ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ (æ—¥ä»˜ã®è‰²ã‚’æ›´æ–°)
        renderCalendar(); 
        
        // â˜…â˜…â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ã“ã“ã‹ã‚‰ â˜…â˜…â˜…
        // ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸå¾Œã€ã‚‚ã—æ—¥ä»˜ãŒé¸æŠä¸­ã§ã‚ã‚Œã°ã€
        // ç©ºãæ ä¸€è¦§ã‚‚è‡ªå‹•ã§å†æç”»ã™ã‚‹ã€‚
        // ã“ã‚Œã«ã‚ˆã‚Šã€åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç©ºãæ ãƒ‡ãƒ¼ã‚¿ãŒæœªç€ã§ã‚‚ã€
        // ãƒ‡ãƒ¼ã‚¿åˆ°ç€å¾Œã«è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
        if (selectedDate) {
             renderAvailableSlots(selectedDate);
        }
        // â˜…â˜…â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ã“ã“ã¾ã§ â˜…â˜…â˜…
    }

    function handleFailureFetch(error) {
        showLoading(false, 'datetime');
        availableSlots = {}; 
        console.error('GASé€šä¿¡ã‚¨ãƒ©ãƒ¼ (ç©ºãæ™‚é–“å–å¾—):', error);
        showMessage('error', `GASã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¨æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${error.message}`);
        renderCalendar();
    }

    function submitBooking(bookingData) {
        document.getElementById('submit-booking-btn').disabled = true;
        showLoading(true, 'info');

        google.script.run
            .withSuccessHandler(handleSuccessBooking)
            .withFailureHandler(handleFailureBooking)
            .createBooking(bookingData);
    }

    function handleSuccessBooking(result) {
        showLoading(false, 'info');

        if (result && result.status === 'success') {
            currentStep = 5;
            updateUI();
            fetchAvailableSlots(); 
        } else if (result && result.status === 'error') {
            showMessage('error', result.error || 'ä¸æ˜ãªäºˆç´„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            document.getElementById('submit-booking-btn').disabled = false;
        } else {
             showMessage('error', `APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚äºˆç´„ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚`);
             document.getElementById('submit-booking-btn').disabled = false;
        }
    }

    function handleFailureBooking(error) {
        showLoading(false, 'info');
        console.error('GASé€šä¿¡ã‚¨ãƒ©ãƒ¼ (äºˆç´„é€ä¿¡):', error);
        showMessage('error', `GASã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚äºˆç´„å‡¦ç†ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ: ${error.message}`);
        document.getElementById('submit-booking-btn').disabled = false;
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- iframe-resizer å­å´ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="https://cdn.jsdelivr.net/npm/iframe-resizer/js/iframeResizer.contentWindow.min.js"></script>
  
  
</body>
</html>